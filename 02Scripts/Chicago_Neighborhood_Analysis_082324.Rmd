---
title: "Chicago Modeling: Probit - R data"
author: "Renata"
date: "2022-12-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


#library(stevemisc) #for simulating censured continuous data
#source( '../orFunctions_jsc.R' )
#Rcpp::sourceCpp( '../cppFns.cpp' )


##Group means for segment data
library(dplyr)

##Visuals
library(ggplot2)

##dataframe manipulation
library(dplyr)

#for your diversity metrics
library(vegan)

#for beta regressions
library(betareg)
library(StepBeta)

#for stepwise poisson
library(My.stepwise)

#for VIF
library(car)

```


##start looking at some basic regressions

Need to start out by looking at the correlations between variables
* even with my efforts to stratify, percent renter and median household income are relatively correlated
* median household income and percent white are super correlated
* Percent white and percent Black are relatively highly correlated
* population density is good with all of them though, highest is percent renter and that is 0.38
* Percent renter is relatively highly correlated to race too

Need to look more into the weights - https://copyprogramming.com/howto/fitting-a-betareg-model-with-weights-in-r 
* basically duplicates the values so if you have 90 trees, it is like you observed the value 90 times, whereas if you have 30 trees, you observed the value 50 times


Beta Bayesian: https://cran.r-project.org/web/packages/betaBayes/betaBayes.pdf
* problem is that it doesn't have weights


```{r basic regressions}
Seg_allData <- read.csv("./ChicagoSegmentData.csv")

wts <- as.vector(Seg_allData$totNumTrees)
Seg_allData$AllConst_since11 <- Seg_allData$NumConst_since11 + Seg_allData$NumReno_since11

#to get a sense of the correlations
# ChiCors <- cor(Seg_allData[,c("PercComm_z", "PercCOMM_MxTree", "PercRes_z","NumConst_since11",
#                               "NumReno_since11", "AllConst_since11",  "NumBuild", "SVI",
#                               "AftTemp","Change_PHL", "Change_PBl","Change_PWnHL",
#                    "Change_MedHHI", "Avg_PRent","Avg_Rmov", "PercWhiteNonHL21",
#                    "MedHouseInc21", "PercRent21","PercRMov21" )])

#write.csv(ChiCors, "./ChicagoPredCors.csv")
#write.csv(Seg_allData, "./ChicagoSegmentData.csv")



###########Model options without super correlated variables
#Have to combine construction and reno because they are too correlated
#could do rentership and recent movers together here

##Because of the correlations above, I think it makes sense to simplify
f1 <- "PercResTree + AvgBA + Change_PWnHL + Change_MedHHI + Avg_Rmov"
f2 <- "PercResTree + AvgBA + SVI + Change_PWnHL + Change_MedHHI + Avg_Rmov"
f3 <- "PercResTree + AvgBA + AllConst_since11 + Change_PWnHL + Change_MedHHI + Avg_Rmov"


########################### Simpson Diversity - species
mods_m4 <- paste(rep("SimpsonsDivSpp ~", 2), c(f1, f2, f3))


f4mod.1 <- betareg(mods_m4[1], data=Seg_allData, weights=wts)
bestf4mod.1 <- StepBeta(f4mod.1)
f4sum.1 <- summary(bestf4mod.1)

f4mod.2 <- betareg(mods_m4[2], data=Seg_allData, weights=wts)
bestf4mod.2 <- StepBeta(f4mod.2)
f4sum.2 <- summary(bestf4mod.2)

f4mod.3 <- betareg(mods_m4[3], data=Seg_allData, weights=wts)
bestf4mod.3 <- StepBeta(f4mod.3)
f4sum.3 <- summary(bestf4mod.3)


AIC(bestf4mod.1, bestf4mod.2, bestf4mod.3)

#             df       AIC
# bestf4mod.1  7 -3463.739
# bestf4mod.2  8 -3466.064
# bestf4mod.3  8 -3652.112

#write.csv(f4sum.2$coefficients$mean, "../04Outputs/Chicago/Chi_SimpsonSpp_Best_2mod4.csv")

############################ Simpson Diversity - genus
mods_m5 <- paste(rep("SimpsonsDivGen ~", 2), c(f1, f2, f3))

f5mod.1 <- betareg(mods_m5[1], data=Seg_allData, weights=wts)
bestf5mod.1 <- StepBeta(f5mod.1)
f5sum.1 <- summary(bestf5mod.1)

f5mod.2 <- betareg(mods_m5[2], data=Seg_allData, weights=wts)
bestf5mod.2 <- StepBeta(f5mod.2)
f5sum.2 <- summary(bestf5mod.2)

f5mod.3 <- betareg(mods_m5[3], data=Seg_allData, weights=wts)
bestf5mod.3 <- StepBeta(f5mod.3)
f5sum.3 <- summary(bestf5mod.3)


AIC(bestf5mod.1, bestf5mod.2, bestf5mod.3)

#             df       AIC
# bestf5mod.1  6 -2593.319
# bestf5mod.2  7 -2595.150
# bestf5mod.3  6 -2593.319

#write.csv(f5sum.1$coefficients$mean, "../04Outputs/Chicago/Chi_SimpsonGen_Best_2mod4.csv")



#This model should be different because should not use number of commercial
##trees as a predictor here
f1.2 <- "PercRes_z  + AvgBA + Change_PWnHL + Change_MedHHI + Avg_Rmov"
f2.2 <- "PercRes_z  + AvgBA + SVI + Change_PWnHL + Change_MedHHI + Avg_Rmov"
f3.2 <- "PercRes_z  + AvgBA + AllConst_since11 + Change_PWnHL + Change_MedHHI + Avg_Rmov"

##Number of Trees
mods_m7 <- paste(rep("totNumTrees ~", 2), c(f1.2, f2.2, f3.2))

f7mod.1 <- step(glm(mods_m7[1], family="poisson", data=Seg_allData))
f7sum.1 <- summary(f7mod.1)

f7mod.2 <- step(glm(mods_m7[2], family="poisson", data=Seg_allData))
f7sum.2 <- summary(f7mod.2)

f7mod.3 <- step(glm(mods_m7[3], family="poisson", data=Seg_allData))
f7sum.3 <- summary(f7mod.3)

AIC(f7mod.1, f7mod.2, f7mod.3)

#         df      AIC
# f7mod.1  4 142.0212
# f7mod.2  4 138.8917
# f7mod.3  4 142.0212

#write.csv(f7sum.1$coefficients, "../04Outputs/Chicago/Chi_NumTrees_Best_2mod4.csv")

###Urban Tolerance
mods_m8 <- paste(rep("PercUrbanApp ~", 2), c(f1, f2, f3))

f8mod.1 <- betareg(mods_m8[1], data=Seg_allData, weights=wts)
bestf8mod.1 <- StepBeta(f8mod.1)
f8sum.1 <- summary(bestf8mod.1)

f8mod.2 <- betareg(mods_m8[2], data=Seg_allData, weights=wts)
bestf8mod.2 <- StepBeta(f8mod.2)
f8sum.2 <- summary(bestf8mod.2)

f8mod.3 <- betareg(mods_m8[3], data=Seg_allData, weights=wts)
bestf8mod.3 <- StepBeta(f8mod.3)
f8sum.3 <- summary(bestf8mod.3)

AIC(bestf8mod.1, bestf8mod.2, bestf8mod.3)

#             df       AIC
# bestf8mod.1  6 -1985.569
# bestf8mod.2  7 -1985.752
# bestf8mod.3  8 -1999.153

#write.csv(f8sum.2$coefficients, "../04Outputs/Chicago/Chi_UrbanApp_Best_2mod4.csv")

##########################################################Tree Health

###########################PercDisc3o4
mods_m9 <- paste(rep("PercDisc3o4 ~", 2), c(f1, f2, f3))

f9mod.1 <- betareg(mods_m9[1], data=Seg_allData, weights=wts)
bestf9mod.1 <- StepBeta(f9mod.1)
f9sum.1 <- summary(bestf9mod.1)

f9mod.2 <- betareg(mods_m9[2], data=Seg_allData, weights=wts)
bestf9mod.2 <- StepBeta(f9mod.2)
f9sum.2 <- summary(bestf9mod.2)

f9mod.3 <- betareg(mods_m9[3], data=Seg_allData, weights=wts)
bestf9mod.3 <- StepBeta(f9mod.3)
f9sum.3 <- summary(bestf9mod.3)

AIC(bestf9mod.1, bestf9mod.2, bestf9mod.3)

#             df       AIC
# bestf9mod.1  7 -2845.292
# bestf9mod.2  8 -2845.253
# bestf9mod.3  7 -2854.339

#write.csv(f9sum.2$coefficients, "../04Outputs/Chicago/Chi_Discol_Best_2mod4.csv")

###########################PercDBK5
mods_m10 <- paste(rep("PercDBK5 ~", 2), c(f1, f2, f3))

f10mod.1 <- betareg(mods_m10[1], data=Seg_allData, weights=wts)
bestf10mod.1 <- StepBeta(f10mod.1)
f10sum.1 <- summary(bestf10mod.1)

f10mod.2 <- betareg(mods_m10[2], data=Seg_allData, weights=wts)
bestf10mod.2 <- StepBeta(f10mod.2)
f10sum.2 <- summary(bestf10mod.2)

f10mod.3 <- betareg(mods_m10[3], data=Seg_allData, weights=wts)
bestf10mod.3 <- StepBeta(f10mod.3)
f10sum.3 <- summary(bestf10mod.3)


AIC(bestf10mod.1, bestf10mod.2, bestf10mod.3)

#              df       AIC
# bestf10mod.1  6 -3002.676
# bestf10mod.2  7 -3063.157
# bestf10mod.3  8 -3239.208

#write.csv(f10sum.2$coefficients, "../04Outputs/Chicago/Chi_DBK_Best_2mod4.csv")

###########################PercCS4o5
mods_m11 <- paste(rep("PercCS4o5 ~", 2), c(f1, f2, f3))

f11mod.1 <- betareg(mods_m11[1], data=Seg_allData, weights=wts)
bestf11mod.1 <- StepBeta(f11mod.1)
f11sum.1 <- summary(bestf11mod.1)

f11mod.2 <- betareg(mods_m11[2], data=Seg_allData, weights=wts)
bestf11mod.2 <- StepBeta(f11mod.2)
f11sum.2 <- summary(bestf11mod.2)

f11mod.3 <- betareg(mods_m11[3], data=Seg_allData, weights=wts)
bestf11mod.3 <- StepBeta(f11mod.3)
f11sum.3 <- summary(bestf11mod.3)


AIC(bestf11mod.1, bestf11mod.2, bestf11mod.3)

#              df       AIC
# bestf11mod.1  7 -2546.494
# bestf11mod.2  8 -2560.262
# bestf11mod.3  8 -2616.825


#write.csv(f11sum.2$coefficients, "../04Outputs/Chicago/Chi_CS_Best_2mod4.csv")

##store data from the "best" models
cnms <- c("ModelType", "DepVar", "model", "R2")
ModOverview <- as.data.frame(matrix(0, nrow=6, ncol=length(cnms)))
names(ModOverview) <- cnms

modList <- list(f4sum.3, f7sum.2, f8sum.3, f9sum.3, f10sum.3, f11sum.3)
modTyps <- c("beta", "pois", "beta", "beta", "beta", "beta")
modDep <- c("SimpDivSpp", "NumTrees", "PercUrbanApp", "PercDisc", "PercDBK", "PercCS")

for (m in 1:6){

  mod <- modList[[m]]
  modT <- modTyps[m]

  ModOverview$ModelType[m] <- modT
  ModOverview$DepVar[m] <- modDep[m]

  #store data for diff model types
  if(modT == "beta"){

    ModOverview$model[m] <- as.character(mod$call)
    ModOverview$R2[m] <- mod$pseudo.r.squared

    pm <- mod$coefficients$mean

  } else if (modT == "lin"){

    ModOverview$model[m] <- as.character(mod$call)[2]
    ModOverview$R2[m] <- mod$adj.r.squared

    pm <- mod$coefficients

  }else if (modT == "pois"){
    ModOverview$model[m] <- as.character(mod$call)[2]
    ModOverview$R2[m] <- with(mod, 1-deviance/null.deviance)

    pm <- mod$coefficients

  }

  ##printout the coefficient values

  write.csv(pm, paste("../04Outputs/Chicago/", modDep[m], "082324.csv", sep=""))


}

write.csv(ModOverview, "../04Outputs/Chicago/Chi_ModelOverviewResults_082324.csv")




```

